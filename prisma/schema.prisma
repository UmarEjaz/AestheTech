// This is your Prisma schema file,
// learn more about it in the docs: https://pris.ly/d/prisma-schema

generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

// ============================================
// ENUMS
// ============================================

enum Role {
  SUPER_ADMIN
  OWNER
  ADMIN
  STAFF
  RECEPTIONIST
}

enum AppointmentStatus {
  SCHEDULED
  CONFIRMED
  IN_PROGRESS
  COMPLETED
  CANCELLED
  NO_SHOW
}

enum InvoiceStatus {
  PENDING
  PAID
  OVERDUE
  CANCELLED
  REFUNDED
}

enum PaymentMethod {
  CASH
  CARD
  DIGITAL_WALLET
  LOYALTY_POINTS
  OTHER
}

enum ShiftType {
  OPENING
  CLOSING
  REGULAR
  SPLIT
}

enum LoyaltyTier {
  SILVER
  GOLD
  PLATINUM
}

enum LoyaltyTransactionType {
  EARNED
  REDEEMED
  BONUS
  EXPIRED
  ADJUSTMENT
}

enum RecurrencePattern {
  DAILY
  WEEKLY
  BIWEEKLY
  MONTHLY
  CUSTOM
  SPECIFIC_DAYS   // Mon/Wed/Fri style
  NTH_WEEKDAY     // "2nd Tuesday of month"
}

enum RecurrenceEndType {
  NEVER           // Ongoing until cancelled
  AFTER_COUNT     // End after N occurrences
  BY_DATE         // End by specific date
}

// ============================================
// MODELS
// ============================================

// User model for staff/admin accounts
model User {
  id        String   @id @default(cuid())
  email     String   @unique
  password  String
  role      Role
  firstName String
  lastName  String
  phone     String?
  isActive  Boolean  @default(true)
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  // Relations
  appointments       Appointment[] @relation("StaffAppointments")
  schedules          Schedule[]
  sales              Sale[]
  saleItems          SaleItem[]
  refunds            Refund[]
  recurringSeries    RecurringAppointmentSeries[] @relation("RecurringStaffAppointments")

  @@map("users")
}

// Client model for customers
model Client {
  id          String    @id @default(cuid())
  firstName   String
  lastName    String?
  email       String?
  phone       String?   @unique
  birthday    DateTime?
  address     String?
  notes       String?
  preferences String?
  allergies   String?
  tags        String[]
  isActive    Boolean   @default(true)
  isWalkIn    Boolean   @default(false)
  createdAt   DateTime  @default(now())
  updatedAt   DateTime  @updatedAt

  // Relations
  appointments        Appointment[]
  sales               Sale[]
  invoices            Invoice[]
  loyaltyPoints       LoyaltyPoints?
  loyaltyTransactions LoyaltyTransaction[]
  recurringSeries     RecurringAppointmentSeries[]

  @@index([isWalkIn])
  @@map("clients")
}

// Service model
model Service {
  id          String   @id @default(cuid())
  name        String
  description String?
  duration    Int      // in minutes
  price       Decimal  @db.Decimal(10, 2)
  points      Int      @default(0) // loyalty points earned
  category    String?
  isActive    Boolean  @default(true)
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt

  // Relations
  appointments    Appointment[]
  saleItems       SaleItem[]
  recurringSeries RecurringAppointmentSeries[]

  @@map("services")
}

// Appointment model
model Appointment {
  id                   String            @id @default(cuid())
  clientId             String
  serviceId            String
  staffId              String
  startTime            DateTime
  endTime              DateTime
  status               AppointmentStatus @default(SCHEDULED)
  notes                String?
  seriesId             String?
  isDetachedFromSeries Boolean           @default(false) // True if edited independently from series
  createdAt            DateTime          @default(now())
  updatedAt            DateTime          @updatedAt

  // Relations
  client  Client                      @relation(fields: [clientId], references: [id], onDelete: Cascade)
  service Service                     @relation(fields: [serviceId], references: [id])
  staff   User                        @relation("StaffAppointments", fields: [staffId], references: [id])
  series  RecurringAppointmentSeries? @relation(fields: [seriesId], references: [id], onDelete: SetNull)

  @@index([clientId])
  @@index([staffId])
  @@index([startTime])
  @@index([seriesId])
  @@map("appointments")
}

// Sale model
model Sale {
  id          String   @id @default(cuid())
  clientId    String
  staffId     String
  totalAmount Decimal  @db.Decimal(10, 2)
  discount    Decimal  @default(0) @db.Decimal(10, 2)
  finalAmount Decimal  @db.Decimal(10, 2)
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt

  // Relations
  client              Client               @relation(fields: [clientId], references: [id])
  staff               User                 @relation(fields: [staffId], references: [id])
  items               SaleItem[]
  invoice             Invoice?
  loyaltyTransactions LoyaltyTransaction[]

  @@index([clientId])
  @@index([staffId])
  @@index([createdAt])
  @@map("sales")
}

// SaleItem model (line items)
model SaleItem {
  id        String   @id @default(cuid())
  saleId    String
  serviceId String
  staffId   String   // staff who performed the service
  quantity  Int      @default(1)
  price     Decimal  @db.Decimal(10, 2)
  createdAt DateTime @default(now())

  // Relations
  sale    Sale    @relation(fields: [saleId], references: [id], onDelete: Cascade)
  service Service @relation(fields: [serviceId], references: [id])
  staff   User    @relation(fields: [staffId], references: [id])

  @@index([saleId])
  @@map("sale_items")
}

// Invoice model
model Invoice {
  id            String        @id @default(cuid())
  invoiceNumber String        @unique
  saleId        String        @unique
  clientId      String
  amount        Decimal       @db.Decimal(10, 2)
  tax           Decimal       @default(0) @db.Decimal(10, 2)
  total         Decimal       @db.Decimal(10, 2)
  status        InvoiceStatus @default(PENDING)
  issuedAt      DateTime      @default(now())
  paidAt        DateTime?
  refundedAt    DateTime?
  createdAt     DateTime      @default(now())
  updatedAt     DateTime      @updatedAt

  // Relations
  sale     Sale      @relation(fields: [saleId], references: [id])
  client   Client    @relation(fields: [clientId], references: [id])
  payments Payment[]
  refunds  Refund[]

  @@index([clientId])
  @@index([invoiceNumber])
  @@index([status])
  @@map("invoices")
}

// Payment model
model Payment {
  id        String        @id @default(cuid())
  invoiceId String
  amount    Decimal       @db.Decimal(10, 2)
  method    PaymentMethod
  paidAt    DateTime      @default(now())
  createdAt DateTime      @default(now())

  // Relations
  invoice Invoice @relation(fields: [invoiceId], references: [id])

  @@index([invoiceId])
  @@map("payments")
}

// Refund model
model Refund {
  id              String        @id @default(cuid())
  invoiceId       String
  amount          Decimal       @db.Decimal(10, 2)
  reason          String?
  refundedById    String
  pointsReversed  Int           @default(0)
  createdAt       DateTime      @default(now())

  // Relations
  invoice    Invoice @relation(fields: [invoiceId], references: [id])
  refundedBy User    @relation(fields: [refundedById], references: [id])

  @@index([invoiceId])
  @@map("refunds")
}

// Schedule model
model Schedule {
  id          String    @id @default(cuid())
  staffId     String
  dayOfWeek   Int       // 0 = Sunday, 6 = Saturday
  startTime   String    // HH:mm format
  endTime     String    // HH:mm format
  shiftType   ShiftType @default(REGULAR)
  isAvailable Boolean   @default(true)
  createdAt   DateTime  @default(now())
  updatedAt   DateTime  @updatedAt

  // Relations
  staff User @relation(fields: [staffId], references: [id], onDelete: Cascade)

  @@index([staffId])
  @@map("schedules")
}

// LoyaltyPoints model
model LoyaltyPoints {
  id        String      @id @default(cuid())
  clientId  String      @unique
  balance   Int         @default(0)
  tier      LoyaltyTier @default(SILVER)
  createdAt DateTime    @default(now())
  updatedAt DateTime    @updatedAt

  // Relations
  client Client @relation(fields: [clientId], references: [id], onDelete: Cascade)

  @@map("loyalty_points")
}

// LoyaltyTransaction model
model LoyaltyTransaction {
  id          String                 @id @default(cuid())
  clientId    String
  saleId      String?
  points      Int
  type        LoyaltyTransactionType
  description String?
  createdAt   DateTime               @default(now())

  // Relations
  client Client @relation(fields: [clientId], references: [id], onDelete: Cascade)
  sale   Sale?  @relation(fields: [saleId], references: [id])

  @@index([clientId])
  @@map("loyalty_transactions")
}

// Recurring appointment series model
model RecurringAppointmentSeries {
  id          String            @id @default(cuid())
  clientId    String
  serviceId   String
  staffId     String

  // Recurrence config
  pattern     RecurrencePattern
  customWeeks Int?              // For CUSTOM: every N weeks
  dayOfWeek   Int               // 0-6 (Sun-Sat) - primary day for WEEKLY/BIWEEKLY/MONTHLY/NTH_WEEKDAY
  timeOfDay   String            // "HH:mm" format
  notes       String?

  // Extended pattern config
  specificDays      Int[]             // For SPECIFIC_DAYS: [1,3,5] = Mon,Wed,Fri (0=Sun, 6=Sat)
  nthWeek           Int?              // For NTH_WEEKDAY: 1-5 (1st, 2nd, 3rd, 4th, 5=last)

  // End conditions
  endType           RecurrenceEndType @default(NEVER)
  endAfterCount     Int?              // For AFTER_COUNT: end after N occurrences
  endByDate         DateTime?         // For BY_DATE: end by specific date
  occurrencesCreated Int              @default(0) // Track how many created

  // Price lock
  lockedPrice       Decimal?          @db.Decimal(10, 2) // Lock price at series creation

  // Buffer time
  bufferMinutes     Int               @default(0) // Buffer between appointments

  // Pause/Resume
  isPaused          Boolean           @default(false)
  pausedAt          DateTime?
  pausedUntil       DateTime?         // Optional: auto-resume date

  // Status
  isActive          Boolean           @default(true)
  createdAt         DateTime          @default(now())
  updatedAt         DateTime          @updatedAt

  // Relations
  client       Client                       @relation(fields: [clientId], references: [id], onDelete: Cascade)
  service      Service                      @relation(fields: [serviceId], references: [id])
  staff        User                         @relation("RecurringStaffAppointments", fields: [staffId], references: [id])
  appointments Appointment[]
  exceptions   RecurringSeriesException[]
  auditLogs    RecurringSeriesAuditLog[]

  @@index([clientId])
  @@index([serviceId])
  @@index([staffId])
  @@index([isActive])
  @@index([isPaused])
  @@map("recurring_appointment_series")
}

// Exception dates for recurring series (skip specific dates)
model RecurringSeriesException {
  id        String   @id @default(cuid())
  seriesId  String
  date      DateTime @db.Date // The date to skip
  reason    String?  // Optional reason (e.g., "Holiday", "Vacation")
  createdAt DateTime @default(now())

  // Relations
  series RecurringAppointmentSeries @relation(fields: [seriesId], references: [id], onDelete: Cascade)

  @@unique([seriesId, date])
  @@index([seriesId])
  @@map("recurring_series_exceptions")
}

// Audit log for recurring series changes
model RecurringSeriesAuditLog {
  id          String   @id @default(cuid())
  seriesId    String
  action      String   // CREATED, UPDATED, PAUSED, RESUMED, CANCELLED, EXCEPTION_ADDED, EXCEPTION_REMOVED, etc.
  changes     Json?    // What changed (before/after)
  performedBy String   // User ID who made the change
  createdAt   DateTime @default(now())

  // Relations
  series RecurringAppointmentSeries @relation(fields: [seriesId], references: [id], onDelete: Cascade)

  @@index([seriesId])
  @@index([performedBy])
  @@map("recurring_series_audit_logs")
}

// Currency enum
enum Currency {
  USD
  PKR
}

// Settings model for salon configuration
model Settings {
  id                   String   @id @default(cuid())
  salonName            String   @default("AestheTech Salon")
  salonAddress         String?  // Full address for invoices
  salonPhone           String?  // Contact phone for invoices
  salonEmail           String?  // Contact email for invoices
  salonLogo            String?  // Base64 encoded logo for invoices
  currency             Currency @default(USD)
  currencySymbol       String   @default("$")
  taxRate              Decimal  @default(0) @db.Decimal(5, 2) // percentage
  businessHoursStart   String   @default("09:00") // HH:mm format
  businessHoursEnd     String   @default("19:00") // HH:mm format
  appointmentInterval  Int      @default(30) // minutes
  allowOnlineBooking   Boolean  @default(true)
  loyaltyPointsPerDollar Int    @default(1)
  createdAt            DateTime @default(now())
  updatedAt            DateTime @updatedAt

  @@map("settings")
}
