// This is your Prisma schema file,
// learn more about it in the docs: https://pris.ly/d/prisma-schema

generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

// ============================================
// ENUMS
// ============================================

enum Role {
  SUPER_ADMIN
  OWNER
  ADMIN
  STAFF
  RECEPTIONIST
}

enum AppointmentStatus {
  SCHEDULED
  CONFIRMED
  IN_PROGRESS
  COMPLETED
  CANCELLED
  NO_SHOW
}

enum InvoiceStatus {
  PENDING
  PAID
  OVERDUE
  CANCELLED
}

enum PaymentMethod {
  CASH
  CARD
  DIGITAL_WALLET
  LOYALTY_POINTS
  OTHER
}

enum ShiftType {
  OPENING
  CLOSING
  REGULAR
  SPLIT
}

enum LoyaltyTier {
  SILVER
  GOLD
  PLATINUM
}

enum LoyaltyTransactionType {
  EARNED
  REDEEMED
  BONUS
  EXPIRED
}

// ============================================
// MODELS
// ============================================

// User model for staff/admin accounts
model User {
  id        String   @id @default(cuid())
  email     String   @unique
  password  String
  role      Role
  firstName String
  lastName  String
  phone     String?
  isActive  Boolean  @default(true)
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  // Relations
  appointments Appointment[] @relation("StaffAppointments")
  schedules    Schedule[]
  sales        Sale[]
  saleItems    SaleItem[]

  @@map("users")
}

// Client model for customers
model Client {
  id          String    @id @default(cuid())
  firstName   String
  lastName    String
  email       String?
  phone       String    @unique
  birthday    DateTime?
  address     String?
  notes       String?
  preferences String?
  allergies   String?
  tags        String[]
  isActive    Boolean   @default(true)
  createdAt   DateTime  @default(now())
  updatedAt   DateTime  @updatedAt

  // Relations
  appointments        Appointment[]
  sales               Sale[]
  invoices            Invoice[]
  loyaltyPoints       LoyaltyPoints?
  loyaltyTransactions LoyaltyTransaction[]

  @@map("clients")
}

// Service model
model Service {
  id          String   @id @default(cuid())
  name        String
  description String?
  duration    Int      // in minutes
  price       Decimal  @db.Decimal(10, 2)
  points      Int      @default(0) // loyalty points earned
  category    String?
  isActive    Boolean  @default(true)
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt

  // Relations
  appointments Appointment[]
  saleItems    SaleItem[]

  @@map("services")
}

// Appointment model
model Appointment {
  id        String            @id @default(cuid())
  clientId  String
  serviceId String
  staffId   String
  startTime DateTime
  endTime   DateTime
  status    AppointmentStatus @default(SCHEDULED)
  notes     String?
  createdAt DateTime          @default(now())
  updatedAt DateTime          @updatedAt

  // Relations
  client  Client  @relation(fields: [clientId], references: [id], onDelete: Cascade)
  service Service @relation(fields: [serviceId], references: [id])
  staff   User    @relation("StaffAppointments", fields: [staffId], references: [id])

  @@index([clientId])
  @@index([staffId])
  @@index([startTime])
  @@map("appointments")
}

// Sale model
model Sale {
  id          String   @id @default(cuid())
  clientId    String
  staffId     String
  totalAmount Decimal  @db.Decimal(10, 2)
  discount    Decimal  @default(0) @db.Decimal(10, 2)
  finalAmount Decimal  @db.Decimal(10, 2)
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt

  // Relations
  client              Client               @relation(fields: [clientId], references: [id])
  staff               User                 @relation(fields: [staffId], references: [id])
  items               SaleItem[]
  invoice             Invoice?
  loyaltyTransactions LoyaltyTransaction[]

  @@index([clientId])
  @@index([staffId])
  @@index([createdAt])
  @@map("sales")
}

// SaleItem model (line items)
model SaleItem {
  id        String   @id @default(cuid())
  saleId    String
  serviceId String
  staffId   String   // staff who performed the service
  quantity  Int      @default(1)
  price     Decimal  @db.Decimal(10, 2)
  createdAt DateTime @default(now())

  // Relations
  sale    Sale    @relation(fields: [saleId], references: [id], onDelete: Cascade)
  service Service @relation(fields: [serviceId], references: [id])
  staff   User    @relation(fields: [staffId], references: [id])

  @@index([saleId])
  @@map("sale_items")
}

// Invoice model
model Invoice {
  id            String        @id @default(cuid())
  invoiceNumber String        @unique
  saleId        String        @unique
  clientId      String
  amount        Decimal       @db.Decimal(10, 2)
  tax           Decimal       @default(0) @db.Decimal(10, 2)
  total         Decimal       @db.Decimal(10, 2)
  status        InvoiceStatus @default(PENDING)
  issuedAt      DateTime      @default(now())
  paidAt        DateTime?
  createdAt     DateTime      @default(now())
  updatedAt     DateTime      @updatedAt

  // Relations
  sale     Sale      @relation(fields: [saleId], references: [id])
  client   Client    @relation(fields: [clientId], references: [id])
  payments Payment[]

  @@index([clientId])
  @@index([invoiceNumber])
  @@index([status])
  @@map("invoices")
}

// Payment model
model Payment {
  id        String        @id @default(cuid())
  invoiceId String
  amount    Decimal       @db.Decimal(10, 2)
  method    PaymentMethod
  paidAt    DateTime      @default(now())
  createdAt DateTime      @default(now())

  // Relations
  invoice Invoice @relation(fields: [invoiceId], references: [id])

  @@index([invoiceId])
  @@map("payments")
}

// Schedule model
model Schedule {
  id          String    @id @default(cuid())
  staffId     String
  dayOfWeek   Int       // 0 = Sunday, 6 = Saturday
  startTime   String    // HH:mm format
  endTime     String    // HH:mm format
  shiftType   ShiftType @default(REGULAR)
  isAvailable Boolean   @default(true)
  createdAt   DateTime  @default(now())
  updatedAt   DateTime  @updatedAt

  // Relations
  staff User @relation(fields: [staffId], references: [id], onDelete: Cascade)

  @@index([staffId])
  @@map("schedules")
}

// LoyaltyPoints model
model LoyaltyPoints {
  id        String      @id @default(cuid())
  clientId  String      @unique
  balance   Int         @default(0)
  tier      LoyaltyTier @default(SILVER)
  createdAt DateTime    @default(now())
  updatedAt DateTime    @updatedAt

  // Relations
  client Client @relation(fields: [clientId], references: [id], onDelete: Cascade)

  @@map("loyalty_points")
}

// LoyaltyTransaction model
model LoyaltyTransaction {
  id          String                 @id @default(cuid())
  clientId    String
  saleId      String?
  points      Int
  type        LoyaltyTransactionType
  description String?
  createdAt   DateTime               @default(now())

  // Relations
  client Client @relation(fields: [clientId], references: [id], onDelete: Cascade)
  sale   Sale?  @relation(fields: [saleId], references: [id])

  @@index([clientId])
  @@map("loyalty_transactions")
}

// Currency enum
enum Currency {
  USD
  PKR
}

// Settings model for salon configuration
model Settings {
  id                   String   @id @default(cuid())
  salonName            String   @default("AestheTech Salon")
  currency             Currency @default(USD)
  currencySymbol       String   @default("$")
  taxRate              Decimal  @default(0) @db.Decimal(5, 2) // percentage
  businessHoursStart   String   @default("09:00") // HH:mm format
  businessHoursEnd     String   @default("19:00") // HH:mm format
  appointmentInterval  Int      @default(30) // minutes
  allowOnlineBooking   Boolean  @default(true)
  loyaltyPointsPerDollar Int    @default(1)
  createdAt            DateTime @default(now())
  updatedAt            DateTime @updatedAt

  @@map("settings")
}
